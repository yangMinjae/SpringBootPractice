<!doctype html>
<html lang="en">
<link rel="stylesheet" href="/main.css">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>
    <form id = "signupForm">
        <input name="name" placeholder="이름">
        <input name="loginId" placeholder="아이디">
        <input name="password" type="password" placeholder="password">
        <button type="submit" id="btn1">전송</button>
    </form>

<script type="text/javascript">
    const signupForm = document.querySelector('#signupForm');


    signupForm.addEventListener('submit', async (e) => {
        // [중요] 동기식 전송(새로고침)을 막습니다.
        e.preventDefault();

        // 이제 아래 로직은 클릭뿐만 아니라 엔터를 쳤을 때도 실행됩니다.
        const name = document.querySelector('input[name="name"]').value.trim();
        const loginId = document.querySelector('input[name="loginId"]').value.trim();
        const password = document.querySelector('input[name="password"]').value.trim();

        // --- 검증 로직 시작 ---
        if (!loginId || loginId.length < 4 || loginId.length > 20) {
            alert("아이디는 4~20자 사이여야 하며 필수 입력 값입니다.");
            return;
        }

        const passwordRegex = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*#?&])[A-Za-z\d@$!%*#?&]{8,}$/;
        if (!passwordRegex.test(password)) {
            alert("비밀번호는 8자 이상, 영문, 숫자, 특수문자를 모두 포함해야 합니다.");
            return;
        }

        if (!name) {
            alert("이름은 필수 입력 값입니다.");
            return;
        }
        // --- 검증 로직 끝 ---

        const data = {
            name : name,
            loginId : loginId,
            password : password
        };

        try {
            const response = await fetch('/member', {
                method: "POST",
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                alert("회원가입 완료");
                location.href = "/list";
            } else {
                const rawData = await response.text();
                try {
                    const errors = JSON.parse(rawData);
                    const firstKey = Object.keys(errors)[0];
                    alert(errors[firstKey]);
                } catch (err) {
                    alert(rawData);
                }
            }
        } catch (error) {
            console.error(error);
            alert('전송 중 오류가 발생했습니다.');
        }
    });
</script>
</body>
</html>